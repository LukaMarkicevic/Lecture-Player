<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lecture Player</title>
    <link rel="icon" type="image/svg+xml" href="/static/icon.svg" style="background-color: white;">
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background-color: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .upload-section {
            margin-bottom: 30px;
            text-align: center;
        }
        .upload-boxes {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin: 20px 0;
        }
        .upload-box {
            flex: 1;
            max-width: 400px;
            padding: 20px;
            border-radius: 12px;
            background-color: white;
            border: 3px solid;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .upload-box:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .upload-box.audio {
            border-color: #2196f3;
        }
        .upload-box.subtitle {
            border-color: #4caf50;
        }
        .upload-box input[type="file"] {
            display: none;
        }
        .upload-box label {
            display: block;
            cursor: pointer;
        }
        .upload-box .icon {
            font-size: 48px;
            margin-bottom: 10px;
        }
        .upload-box .title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .upload-box .description {
            color: #666;
            font-size: 14px;
        }
        .player-section {
            margin-bottom: 20px;
        }
        audio {
            width: 100%;
            margin-bottom: 20px;
            border-radius: 8px;
        }
        .subtitle-container {
            max-height: 400px;
            overflow-y: auto;
            padding: 15px;
            border: 1px solid #eee;
            border-radius: 8px;
            background-color: #fafafa;
        }
        .subtitle-item {
            padding: 12px;
            margin: 8px 0;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            background-color: white;
            border: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .subtitle-item .text {
            flex: 1;
            margin-right: 15px;
        }
        .subtitle-item .timestamp {
            color: #666;
            font-size: 0.9em;
            white-space: nowrap;
        }
        .subtitle-item:hover {
            background-color: #f0f0f0;
            transform: translateX(5px);
        }
        .subtitle-item.active {
            background-color: #e3f2fd;
            border-color: #2196f3;
        }
        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
        }
        .grouping-control {
            display: flex;
            align-items: center;
            gap: 8px;
            background-color: #f8f9fa;
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid #e0e0e0;
        }
        .grouping-control input {
            width: 60px;
            padding: 4px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            background-color: #2196f3;
            color: white;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        button.active {
            background-color: #1976d2;
        }
        button:hover {
            background-color: #1976d2;
            transform: translateY(-2px);
        }
        .info-message {
            background-color: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
            color: #1976d2;
        }
        .info-message strong {
            color: #1565c0;
        }
        .title-icon {
            width: 32px;
            height: 32px;
            vertical-align: middle;
            margin-right: 10px;
        }
        .button-icon {
            width: 20px;
            height: 20px;
            vertical-align: middle;
            margin-right: 8px;
        }
        .uploaded-files {
            margin-top: 15px;
            padding: 10px;
            border-radius: 6px;
            background-color: #f8f9fa;
            display: none;
        }
        .uploaded-files.show {
            display: block;
        }
        .file-info {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 5px 0;
            padding: 8px;
            background-color: white;
            border-radius: 4px;
            border: 1px solid #e0e0e0;
        }
        .file-info .icon {
            font-size: 20px;
        }
        .file-info .name {
            flex: 1;
            font-size: 14px;
            color: #333;
        }
        .file-info .size {
            font-size: 12px;
            color: #666;
        }
        .player-section.hidden {
            display: none;
        }
        .header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .header-container h1 {
            margin: 0;
        }
        .support-button {
            margin-left: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header-container">
            <h1>Lecture Player with Subtitles</h1>
            <div class="support-button">
                <script type="text/javascript" src="https://cdnjs.buymeacoffee.com/1.0.0/button.prod.min.js" data-name="bmc-button" data-slug="eoBVsrZ" data-color="#5F7FFF" data-emoji="" data-font="Cookie" data-text="Buy me a coffee" data-outline-color="#000000" data-font-color="#ffffff" data-coffee-color="#FFDD00"></script>
            </div>
        </div>
        
        <div class="info-message">
            <strong>Local File Handling:</strong> All files are processed locally on your device. No files are uploaded to any server. 
            Files are temporarily stored in your browser's memory and are cleared when you close the page.
        </div>

        <div class="upload-section" id="uploadSection">
            <h2>Upload Files</h2>
            <div class="upload-boxes">
                <div class="upload-box audio">
                    <label for="audio">
                        <div class="icon">üéôÔ∏è</div>
                        <div class="title">Audio File</div>
                        <div class="description">Upload your audio file (MP3, M4A, WAV, OGG)</div>
                    </label>
                    <input type="file" id="audio" name="audio" accept=".mp3,.m4a,.wav,.ogg" required>
                </div>
                
                <div class="upload-box subtitle">
                    <label for="subtitle">
                        <div class="icon">üìù</div>
                        <div class="title">Subtitle File</div>
                        <div class="description">Upload your SRT file</div>
                    </label>
                    <input type="file" id="subtitle" name="subtitle" accept=".srt" required>
                </div>
            </div>
            <div class="uploaded-files" id="uploadedFiles">
                <div class="file-info">
                    <span class="icon">üéôÔ∏è</span>
                    <span class="name" id="audioFileName"></span>
                    <span class="size" id="audioFileSize"></span>
                </div>
                <div class="file-info">
                    <span class="icon">üìù</span>
                    <span class="name" id="subtitleFileName"></span>
                    <span class="size" id="subtitleFileSize"></span>
                </div>
            </div>
            <button type="submit" id="uploadButton" style="margin-top: 20px;">
                <img src="/static/icon.svg" alt="Icon" class="button-icon">Start Playing
            </button>
        </div>

        <div class="player-section" style="display: none;">
            <audio id="audioPlayer" controls></audio>
            
            <div class="controls">
                <button id="followTextBtn">
                    <span>Follow Text</span>
                </button>
                <div class="grouping-control">
                    <label for="groupingSeconds">Grouping:</label>
                    <input type="number" id="groupingSeconds" min="1" max="60" value="1">
                    <span>seconds</span>
                </div>
                <button id="togglePlayerBtn">
                    <span>‚ñº</span>
                </button>
            </div>

            <div class="subtitle-container" id="subtitleContainer"></div>
        </div>
    </div>

    <script>
        let subtitles = [];
        let currentSubtitleIndex = -1;
        const audioPlayer = document.getElementById('audioPlayer');
        const subtitleContainer = document.getElementById('subtitleContainer');
        const playerSection = document.querySelector('.player-section');
        const uploadButton = document.getElementById('uploadButton');
        const uploadSection = document.getElementById('uploadSection');
        let isFollowingText = false;
        const followTextBtn = document.getElementById('followTextBtn');
        const togglePlayerBtn = document.getElementById('togglePlayerBtn');
        let groupingSeconds = 1;
        const groupingInput = document.getElementById('groupingSeconds');

        // Update button state based on file selection
        function updateUploadButton() {
            const audioFile = document.getElementById('audio').files[0];
            const subtitleFile = document.getElementById('subtitle').files[0];
            const uploadedFiles = document.getElementById('uploadedFiles');
            
            console.log('Files selected:', {
                audio: audioFile ? audioFile.name : 'none',
                subtitle: subtitleFile ? subtitleFile.name : 'none'
            });
            
            uploadButton.disabled = !(audioFile && subtitleFile);
            uploadButton.style.opacity = uploadButton.disabled ? '0.5' : '1';
            
            // Show uploaded files section if either file is selected
            if (audioFile || subtitleFile) {
                uploadedFiles.classList.add('show');
                
                // Update audio file info if present
                if (audioFile) {
                    document.getElementById('audioFileName').textContent = audioFile.name;
                    document.getElementById('audioFileSize').textContent = formatFileSize(audioFile.size);
                } else {
                    document.getElementById('audioFileName').textContent = 'No audio file selected';
                    document.getElementById('audioFileSize').textContent = '';
                }
                
                // Update subtitle file info if present
                if (subtitleFile) {
                    document.getElementById('subtitleFileName').textContent = subtitleFile.name;
                    document.getElementById('subtitleFileSize').textContent = formatFileSize(subtitleFile.size);
                } else {
                    document.getElementById('subtitleFileName').textContent = 'No subtitle file selected';
                    document.getElementById('subtitleFileSize').textContent = '';
                }
            } else {
                uploadedFiles.classList.remove('show');
            }
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        document.getElementById('audio').addEventListener('change', updateUploadButton);
        document.getElementById('subtitle').addEventListener('change', updateUploadButton);

        uploadButton.addEventListener('click', async () => {
            const audioFile = document.getElementById('audio').files[0];
            const subtitleFile = document.getElementById('subtitle').files[0];
            
            console.log('Upload button clicked');
            console.log('Files to upload:', {
                audio: audioFile ? audioFile.name : 'none',
                subtitle: subtitleFile ? subtitleFile.name : 'none'
            });

            if (!audioFile || !subtitleFile) {
                alert('Please select both audio and subtitle files');
                return;
            }

            const formData = new FormData();
            formData.append('audio', audioFile);
            formData.append('subtitle', subtitleFile);

            try {
                console.log('Sending request to server...');
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });
                
                console.log('Response received:', response.status);
                const data = await response.json();
                console.log('Response data:', data);

                if (data.error) {
                    alert(data.error);
                    return;
                }

                subtitles = data.subtitles;
                console.log('Subtitles loaded:', subtitles.length);
                
                audioPlayer.src = data.audio_url;
                console.log('Audio source set:', data.audio_url);
                
                // Show player section and scroll to it
                playerSection.style.display = 'block';
                playerSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                
                // Initialize audio player
                audioPlayer.load();
                console.log('Audio player loaded');
                
                audioPlayer.play().catch(error => {
                    console.log('Auto-play prevented:', error);
                });
                
                renderSubtitles();
                setupAudioListeners();
                
                // Hide upload section
                uploadSection.classList.add('hidden');
            } catch (error) {
                console.error('Error processing files:', error);
                alert('Error processing files: ' + error.message);
            }
        });

        // Add grouping input handler
        groupingInput.addEventListener('change', () => {
            groupingSeconds = Math.max(1, Math.min(60, parseInt(groupingInput.value) || 1));
            groupingInput.value = groupingSeconds;
            renderSubtitles();
        });

        function renderSubtitles() {
            subtitleContainer.innerHTML = '';
            
            // Group subtitles based on time window
            const groupedSubtitles = [];
            let currentGroup = [];
            let groupStartTime = null;
            
            subtitles.forEach((sub, index) => {
                const startTime = timeToSeconds(sub.start);
                
                if (groupStartTime === null) {
                    groupStartTime = startTime;
                    currentGroup.push(sub);
                } else if (startTime - groupStartTime <= groupingSeconds) {
                    currentGroup.push(sub);
                } else {
                    if (currentGroup.length > 0) {
                        groupedSubtitles.push({
                            text: currentGroup.map(s => s.text).join(' '),
                            start: currentGroup[0].start,
                            end: currentGroup[currentGroup.length - 1].end,
                            indices: currentGroup.map(s => subtitles.indexOf(s))
                        });
                    }
                    currentGroup = [sub];
                    groupStartTime = startTime;
                }
            });
            
            // Add the last group if it exists
            if (currentGroup.length > 0) {
                groupedSubtitles.push({
                    text: currentGroup.map(s => s.text).join(' '),
                    start: currentGroup[0].start,
                    end: currentGroup[currentGroup.length - 1].end,
                    indices: currentGroup.map(s => subtitles.indexOf(s))
                });
            }
            
            // Render grouped subtitles
            groupedSubtitles.forEach((group, groupIndex) => {
                const div = document.createElement('div');
                div.className = 'subtitle-item';
                
                const textSpan = document.createElement('span');
                textSpan.className = 'text';
                textSpan.textContent = group.text;
                
                const timeSpan = document.createElement('span');
                timeSpan.className = 'timestamp';
                timeSpan.textContent = group.start;
                
                div.appendChild(textSpan);
                div.appendChild(timeSpan);
                
                // Click handler to seek to the first subtitle in the group
                div.onclick = () => {
                    const firstIndex = group.indices[0];
                    seekToSubtitle(firstIndex);
                };
                
                subtitleContainer.appendChild(div);
            });
        }

        function setupAudioListeners() {
            audioPlayer.addEventListener('timeupdate', () => {
                const currentTime = audioPlayer.currentTime;
                updateActiveSubtitle(currentTime);
            });

            // Add error handling for audio player
            audioPlayer.addEventListener('error', (e) => {
                console.error('Audio player error:', e);
                alert('Error loading audio file. Please try again.');
            });
        }

        // Update the updateActiveSubtitle function to handle grouped subtitles
        function updateActiveSubtitle(currentTime) {
            const subtitleElements = subtitleContainer.children;
            
            Array.from(subtitleElements).forEach(el => el.classList.remove('active'));
            
            // Find the group that contains the current time
            const currentGroup = subtitleElements[Array.from(subtitleElements).findIndex(el => {
                const start = timeToSeconds(el.querySelector('.timestamp').textContent);
                const end = timeToSeconds(subtitles[subtitles.length - 1].end);
                return currentTime >= start && currentTime <= end;
            })];
            
            if (currentGroup) {
                currentGroup.classList.add('active');
                
                // Scroll to active subtitle if following text is enabled
                if (isFollowingText) {
                    currentGroup.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }
        }

        function timeToSeconds(timeStr) {
            try {
                // Handle SRT format (00:00:00,000)
                const [hours, minutes, seconds] = timeStr.split(':');
                const [secs, ms] = seconds.split(',');
                
                // Convert all parts to numbers
                const h = parseInt(hours) || 0;
                const m = parseInt(minutes) || 0;
                const s = parseInt(secs) || 0;
                const milliseconds = parseInt(ms) || 0;
                
                // Calculate total seconds
                return h * 3600 + m * 60 + s + milliseconds / 1000;
            } catch (error) {
                console.error('Error converting time:', timeStr, error);
                return 0;
            }
        }

        function seekToSubtitle(index) {
            try {
                const startTime = timeToSeconds(subtitles[index].start);
                if (isFinite(startTime)) {
                    audioPlayer.currentTime = startTime;
                    audioPlayer.play().catch(error => {
                        console.log('Play prevented:', error);
                    });
                } else {
                    console.error('Invalid time value:', subtitles[index].start);
                }
            } catch (error) {
                console.error('Error seeking to subtitle:', error);
            }
        }

        function seekForward(seconds) {
            audioPlayer.currentTime = Math.min(audioPlayer.duration, audioPlayer.currentTime + seconds);
        }

        function seekBackward(seconds) {
            audioPlayer.currentTime = Math.max(0, audioPlayer.currentTime - seconds);
        }

        // Add follow text toggle functionality
        followTextBtn.addEventListener('click', () => {
            isFollowingText = !isFollowingText;
            followTextBtn.classList.toggle('active');
            followTextBtn.querySelector('span').textContent = isFollowingText ? 'Following Text' : 'Follow Text';
            
            // If enabling follow text, scroll to current subtitle
            if (isFollowingText && currentSubtitleIndex !== -1) {
                const subtitleElements = subtitleContainer.children;
                subtitleElements[currentSubtitleIndex].scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        });

        // Update the toggle button click handler
        togglePlayerBtn.addEventListener('click', () => {
            const toggleIcon = togglePlayerBtn.querySelector('span');
            
            if (uploadSection.classList.contains('hidden')) {
                uploadSection.classList.remove('hidden');
                toggleIcon.textContent = '‚ñº';
            } else {
                uploadSection.classList.add('hidden');
                toggleIcon.textContent = '‚ñ≤';
            }
        });

        // Remove the old toggle button event listener and element
        document.querySelector('.toggle-upload')?.remove();
    </script>
</body>
</html> 